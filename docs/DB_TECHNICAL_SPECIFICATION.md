## **Техническое Задание (Комплексное): Гибридная архитектура AIPrompts Hub**

**Версия:** 2.0
**Дата:** 15.08.2025

### **1. Цель доработки**

Создать масштабируемую, производительную и многофункциональную платформу для управления AI-промптами. Внедрить гибридную архитектуру, где **Supabase** является основным источником данных для мгновенных операций и пользовательского контента, а **репозиторий Git** — версионируемым "холодным" хранилищем для публичной коллекции промптов. Улучшить UX/UI за счет пагинации и современных индикаторов загрузки, а также реализовать полнофункциональную систему комментариев.

-----

### **2. Архитектура и модель данных**

#### **2.1. Гибридная модель хранения**

  - **Supabase (Источник правды):** Основная база данных PostgreSQL для всех операций. Содержит как **приватные** (привязанные к `user_id`), так и **публичные** промпты.
  - **Git (Резервная копия и версионирование):** "Холодное" хранилище, куда **периодически** синхронизируются только **публичные** промпты из Supabase.

#### **2.2. Аутентификация**

  - Все операции по созданию, изменению и удалению данных требуют аутентификации пользователя через **Supabase Auth (JWT)**.
  - Чтение публичных данных (промпты, комментарии) доступно анонимным пользователям.

#### **2.3. Схема таблиц в Supabase**

  - **Таблица `prompts`:**
    ```sql
    CREATE TABLE prompts (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      title TEXT NOT NULL,
      description TEXT,
      content_ru TEXT,
      content_en TEXT,
      variables JSONB,
      prompt_variants JSONB,
      tags TEXT[],
      category TEXT,
      status TEXT DEFAULT 'private', -- 'private', 'public', 'archived'
      is_favorite BOOLEAN DEFAULT false,
      rating REAL DEFAULT 0,
      version TEXT,
      compatible_models TEXT,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      modified_at TIMESTAMPTZ DEFAULT NOW(),
      user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL
    );
    ```
  - **Таблица `comments`:**
    ```sql
    CREATE TABLE comments (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      prompt_id UUID REFERENCES prompts(id) ON DELETE CASCADE,
      content TEXT NOT NULL,
      author_name TEXT NOT NULL,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL -- Опционально
    );
    ```

-----

### **3. Безопасность (Row-Level Security)**

  - **Для таблицы `prompts`:**
      - **Полный доступ для владельца:** Пользователь может выполнять любые CRUD-операции (SELECT, INSERT, UPDATE, DELETE) только над промптами, где `prompts.user_id = auth.uid()`.
      - **Публичное чтение:** Любой пользователь (включая анонимных) может читать (SELECT) промпты, у которых `status = 'active'`.
  - **Для таблицы `comments`:**
      - **Публичное чтение:** Все могут читать все комментарии.
      - **Публичная запись:** Все могут добавлять комментарии (`INSERT`) с проверкой на минимальную длину полей.
      - **Редактирование/Удаление:** Запрещено для всех.

-----

### **4. Описание API и эндпоинтов**

#### **4.1. Прямое взаимодействие с Supabase (Клиент -\> Supabase)**

  * **Назначение:** Для управления **приватными** промптами пользователя.
  * **Операции:** Используются стандартные вызовы клиента `supabase-js` (CREATE, READ, UPDATE, DELETE), которые автоматически применяют RLS-политики.
  * **Примеры:**
      * **Создание:** `supabase.from('prompts').insert([{ title: '...', user_id: user.id }])`
      * **Получение своих промптов:** `supabase.from('prompts').select('*')` (RLS отфильтрует автоматически)
      * **Обновление:** `supabase.from('prompts').update({ ... }).eq('id', ...)`
      * **Удаление:** `supabase.from('prompts').delete().eq('id', ...)`
      * **Поиск (среди своих промптов):** `supabase.rpc('search_prompts', { search_term: '...' })` с использованием предоставленной вами SQL-функции.

#### **4.2. Серверные эндпоинты (Клиент -\> Vercel API)**

  * **Назначение:** Для работы с **публичной** коллекцией промптов и для выполнения системных задач.

  * **`GET /api/get-prompts` (Обновлено)**

      * **Логика:** Получает **публичные** промпты (`status = 'active'`) из Supabase с пагинацией.
      * **Query-параметры:** `page` (номер страницы), `limit` (кол-во на странице).
      * **Ответ:** `{ prompts: [...], hasNextPage: boolean }`

  * **`POST /api/create-prompt-issue` (Логика изменена)**

      * **Назначение:** Предложить приватный промпт для публикации.
      * **Логика:** Принимает `promptId` от аутентифицированного пользователя. Меняет статус промпта в Supabase с `private` на `pending_review` (требует добавления этого статуса) или создает задачу для администратора. **Больше не создает Pull Request напрямую.**

  * **`POST /api/sync-to-github` (Новая, системная)**

      * **Назначение:** Периодическая синхронизация публичных данных в Git.
      * **Логика:** Выбирает из Supabase все промпты со статусом `public`, формирует из них `.json` файлы и создает один коммит в GitHub-репозиторий.
      * **Запуск:** По расписанию через `vercel.json` (Cron Job).

-----

### **5. Улучшения UX/UI (Frontend)**

  - **Пагинация / Бесконечная прокрутка:**
      - При загрузке страницы и прокрутке списка публичных промптов, фронтенд будет вызывать `GET /api/get-prompts` с нужными параметрами `page` и `limit`.
  - **Индикаторы загрузки (Skeleton UI):**
      - Во время ожидания ответа от `/api/get-prompts` на странице будут отображаться анимированные "скелетные" блоки, имитирующие структуру карточек промптов.
  - **Система комментариев:**
      - В модальном окне просмотра промпта будет реализован раздел для комментариев, который напрямую взаимодействует с таблицей `comments` в Supabase для чтения и мгновенной записи.

-----

### **6. Критерии приемки**

1.  **Пользовательский флоу:** Пользователь может логиниться, создавать и управлять своими **приватными** промптами через прямой интерфейс к Supabase.
2.  **Публичный флоу:** Главная страница отображает **публичные** промпты, загруженные с пагинацией через `GET /api/get-prompts`. UX улучшен за счет "скелетных" блоков.
3.  **Синхронизация:** Cron Job на Vercel успешно запускает `/api/sync-to-github`, и публичные промпты из Supabase корректно появляются в Git-репозитории.
4.  **Комментарии:** Система комментариев полностью функциональна: чтение, запись и мгновенное отображение работают корректно.
5.  **Безопасность:** Политики RLS настроены и не позволяют пользователям просматривать или изменять чужие приватные данные.