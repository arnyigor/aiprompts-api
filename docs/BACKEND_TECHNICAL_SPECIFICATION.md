### **Техническое Задание: Бэкенд для проекта "AIPrompts Hub" (Версия 2.1)**

**Версия:** 2.1
**Дата:** 05.08.2025
**Автор:** AI-Аналитик (на основе утвержденной архитектуры)

---

#### **1. Введение**

**1.1. Цель документа**

Настоящее ТЗ описывает требования к архитектуре и API бэкенд-сервиса "AIPrompts Hub", развернутого на платформе Vercel. Документ охватывает как существующую Git-based систему управления контентом (промптами), так и новую гибридную подсистему для управления динамическими данными (рейтинги, комментарии) с использованием нативных хранилищ Vercel.

**1.2. Контекст и Архитектура**

Проект эволюционировал от простого API-шлюза до **гибридной системы**:
*   **Источник правды для контента (Промпты):** Репозиторий GitHub `arnyigor/aiprompts`. Операции записи (создание/обновление) инициируют открытие Pull Request'ов для модерации.
*   **Источник правды для динамических данных (Рейтинги, Комментарии):** Нативные Serverless-хранилища Vercel. Операции записи являются быстрыми и атомарными.

Эта архитектура позволяет использовать сильные стороны каждого подхода: надежность и версионирование Git для контента и производительность баз данных для пользовательского взаимодействия.

---

#### **2. Технологический Стек и Окружение**

*   **Платформа:** Vercel
*   **Среда выполнения:** Node.js
*   **Хранилища данных:**
    *   **Vercel KV (Redis):** Для хранения простых счетчиков (рейтинги).
    *   **Vercel Postgres:** Для хранения структурированных данных (комментарии, новости).
*   **Ключевые зависимости (NPM):**
    *   `@octokit/rest`: Взаимодействие с GitHub REST API.
    *   `zod`: Валидация схем данных.
    *   `next-auth`: Аутентификация через OAuth провайдеры.
    *   `@vercel/kv`: Взаимодействие с Vercel KV.
    *   `@vercel/postgres`: Взаимодействие с Vercel Postgres.
*   **Аутентификация:** GitHub OAuth flow с использованием NextAuth.js. Персональные токены пользователей используются для Git-операций вместо серверного PAT.

---

#### **3. Функциональные Требования: API Эндпоинты**

##### **3.1. Управление Промптами (Git-based)**

*   **`POST /api/create-prompt-issue`**
    *   **Назначение:** Принимает данные нового или обновленного промпта.
    *   **Требования:** Пользователь должен быть аутентифицирован через GitHub OAuth.
    *   **Логика:**
        1.  Проверяет аутентификацию пользователя через сессию.
        2.  Валидирует данные по схеме Zod.
        3.  Определяет, является ли операция созданием, обновлением или "перемещением" (при смене категории).
        4.  Управляет датами `created_at` / `updated_at` на сервере.
        5.  Автоматически добавляет поля `author` и `authorEmail` из профиля пользователя GitHub.
        6.  Создает новую ветку в репозитории `arnyigor/aiprompts` от имени пользователя.
        7.  Выполняет атомарную Git-операцию (создание, обновление или удаление+создание) с помощью Git Tree API, используя токен пользователя.
        8.  Создает Pull Request от имени пользователя с информативным Markdown-описанием для модерации.
    *   **Структура запроса:** Полный объект промпта (без дат и авторских данных).
    *   **Успешный ответ (`201 Created`):** `{ "message": "...", "pullRequestUrl": "..." }`.

*   **`GET /api/get-prompts`**
    *   **Назначение:** Прокси-эндпоинт для безопасной загрузки всех промптов.
    *   **Логика:**
        1.  Используя серверный токен, запрашивает все файлы промптов из репозитория GitHub.
        2.  **(Интеграция)** Запрашивает рейтинги для всех полученных промптов из Vercel KV.
        3.  Обогащает каждый объект промпта данными о рейтинге.
        4.  Возвращает единый массив обогащенных данных.
    *   **Успешный ответ (`200 OK`):** Массив объектов промптов, каждый с полем `rating: { upvotes: number, downvotes: number }`.

##### **3.2. Рейтинги и Комментарии (Vercel Storage)**

*   **`POST /api/vote`**
    *   **Назначение:** Учет голоса за промпт.
    *   **Логика:**
        1.  Принимает `promptId` и `direction` ('up' или 'down').
        2.  Использует `kv.hincrby` для атомарного увеличения счетчика `upvotes` или `downvotes` для ключа `rating:<promptId>`.
    *   **Успешный ответ (`200 OK`):** `{ "upvotes": number, "downvotes": number }`.

*   **`POST /api/comments`**
    *   **Назначение:** Добавление нового комментария.
    *   **Логика:**
        1.  Принимает `promptId`, `authorName`, `content`.
        2.  Создает новую запись в таблице `Comment` в Vercel Postgres.
    *   **Успешный ответ (`201 Created`):** `{ "message": "Comment added" }`.

*   **`GET /api/comments?promptId=<id>`**
    *   **Назначение:** Получение списка комментариев для конкретного промпта.
    *   **Логика:** Выбирает все комментарии из таблицы `Comment`, где `promptId` совпадает, и сортирует их по дате.
    *   **Успешный ответ (`200 OK`):** Массив объектов комментариев.

##### **3.3. Новости (Будущая реализация)**

*   **`GET /api/news`**
    *   **Назначение:** Получение списка новостей.
    *   **Логика:** Выбирает все записи из таблицы `News` в Vercel Postgres, сортирует по дате публикации.
    *   **Успешный ответ (`200 OK`):** Массив объектов новостей.
*   **`POST /api/news` (Защищенный)**
    *   **Назначение:** Добавление новой новости (требует аутентификации администратора).

##### **3.4. Авторизация (GitHub OAuth)**

*   **`GET /api/auth/signin`**
    *   **Назначение:** Инициирует OAuth-поток авторизации через GitHub.
    *   **Логика:**
        1.  Перенаправляет пользователя на GitHub Authorization endpoint.
        2.  Запрашивает scope: `user:email` и `public_repo`.

*   **`GET /api/auth/callback`**
    *   **Назначение:** Обработчик callback от GitHub OAuth.
    *   **Логика:**
        1.  Обменивает временный код на access token.
        2.  Получает профиль пользователя через GitHub API.
        3.  Создает сессию с JWT-токеном.
        4.  Перенаправляет пользователя на главную страницу.

*   **`GET /api/auth/session`**
    *   **Назначение:** Проверка текущей сессии пользователя.
    *   **Логика:**
        1.  Возвращает информацию о текущем пользователе из сессии.
        2.  Возвращает `null`, если пользователь не аутентифицирован.

*   **`POST /api/auth/signout`**
    *   **Назначение:** Завершение сессии пользователя.
    *   **Логика:**
        1.  Удаляет сессионные данные пользователя.
        2.  Перенаправляет на главную страницу.

---

#### **4. Структуры Данных**

##### **4.1. Промпт (JSON в Git)**
Структура соответствует финальной версии из `constructor.js` с добавлением полей автора в секцию metadata:

```json
{
  "id": "UUID",
  "title": "test",
  "version": "1.0.0",
  "status": "active",
  "is_local": false,
  "is_favorite": false,
  "description": "",
  "content": {
    "ru": "",
    "en": ""
  },
  "prompt_variants": [
    {
      "variant_id": {
        "type": "general",
        "id": "1",
        "priority": 1
      },
      "content": {
        "ru": "",
        "en": ""
      }
    }
  ],
  "compatible_models": ["",""],
  "category": "",
  "tags": [
    "general"
  ],
  "variables": [],
  "metadata": {
    "author": {
      "id": "github-username",
      "name": "GitHub User Name",
      "email": "user@example.com"
    },
    "source": "WebApp",
    "notes": ""
  },
  "rating": {
    "score": 0,
    "votes": 0
  },
  "original_category": ""
}
```

##### **4.2. Комментарий (Схема Prisma для Vercel Postgres)**
```prisma
model Comment {
  id         String   @id @default(cuid())
  promptId   String   // Связь с ID промпта из JSON
  authorName String
  content    String
  createdAt  DateTime @default(now())

  @@index([promptId])
}
```

##### **4.3. Рейтинг (Структура Hash в Vercel KV)**
*   **Ключ:** `rating:<promptId>`
*   **Поля:**
    *   `upvotes`: number
    *   `downvotes`: number

##### **4.4. Новость (Схема Prisma для Vercel Postgres)**
```prisma
model News {
  id          String   @id @default(cuid())
  title       String
  content     String   // Содержимое в формате Markdown
  imageUrl    String?
  publishedAt DateTime @default(now())
  authorName  String
}
```

---

#### **5. Нефункциональные Требования**

*   **Безопасность:**
    *   Все секретные ключи (`GITHUB_TOKEN`, `POSTGRES_URL`, `KV_REST_API_URL` и т.д.) должны храниться **только** в переменных окружения Vercel.
    *   Сессионные cookies должны быть защищены флагами `HttpOnly`, `Secure` и `SameSite`.
    *   OAuth scope должен быть ограничен минимально необходимыми правами (`user:email`, `public_repo`).
    *   Реализовать CSRF-защиту для всех форм и критических операций.
    *   Токены пользователей должны храниться только в зашифрованных сессионных cookies, никогда в localStorage.
*   **Производительность:** Эндпоинт `GET /api/get-prompts` должен использовать кеширование Vercel (`Cache-Control: s-maxage=...`) для минимизации запросов к GitHub API.
*   **Масштабируемость:** Использование Serverless-функций и нативных хранилищ Vercel обеспечивает автоматическое масштабирование под нагрузкой.

---

#### **6. План Миграции и Разработки**

1.  **Реализация Авторизации:**
    *   Создать GitHub OAuth App и настроить credentials.
    *   Интегрировать NextAuth.js в проект.
    *   Реализовать middleware для защиты эндпоинтов.
    *   Обновить фронтенд для поддержки авторизации.
2.  **Интеграция Vercel Storage:** Подключить Postgres и KV в дашборде Vercel, настроить переменные окружения.
3.  **Установка зависимостей:** Добавить `@vercel/postgres`, `@vercel/kv`.
4.  **Реализация Рейтингов:**
    *   Создать эндпоинт `POST /api/vote`.
    *   Модифицировать `GET /api/get-prompts` для обогащения данных.
    *   Интегрировать на фронтенде.
5.  **Реализация Комментариев:**
    *   Настроить Prisma и создать миграцию для таблицы `Comment`.
    *   Создать эндпоинты `POST /api/comments` и `GET /api/comments`.
    *   Интегрировать на фронтенде.
6.  **Реализация Новостей (будущий этап):**
    *   Создать миграцию Prisma для таблицы `News`.
    *   Создать эндпоинты `GET /api/news` и (позже) защищенный `POST /api/news`.
    *   Создать новый раздел в UI.